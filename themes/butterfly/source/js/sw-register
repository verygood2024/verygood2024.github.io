if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').then(reg => {
    reg.onupdatefound = () => {
      const newSW = reg.installing;
      if (!newSW) return;

      newSW.addEventListener('statechange', () => {
        if (
          newSW.state === 'installed' &&
          navigator.serviceWorker.controller
        ) {
          // ✅ 有旧 SW 控制，说明这是一次更新
          console.log('[SW] 检测到新版本，使用 PJAX 自动加载最新内容');

          // ✅ 使用 PJAX 自动刷新当前页面内容（无需跳转）
          if (window.Pjax) {
            new Pjax().reload();
          } else if (window.PJAX) {
            window.PJAX.reload(); // 兼容部分主题
          } else {
            location.reload(); // fallback：实在不行才整页刷新
          }
        }
      });
    };
  }).catch(console.error);
}
